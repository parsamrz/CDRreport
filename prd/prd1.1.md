این هم مستند کامل نیازمندی‌های محصول (PRD) به زبان فارسی، که با توجه به تحلیل فایل CSV شما و با نگاهی دقیق و فنی (به عنوان یک مدیر محصول و آرشیتکت ارشد) تدوین شده است.

-----

# مستند نیازمندی‌های محصول (PRD)

**نام پروژه:** سامانه تحلیل و داشبورد تماس‌ها (CDR Analyzer)
**نسخه:** 1.0
**وضعیت:** آماده برای توسعه
**تاریخ:** 1403/09/20 (2025-12-10)

-----

## ۱. نمای کلی (Overview)

**خلاصه:**
این محصول یک وب‌اپلیکیشن تک‌صفحه‌ای (SPA) است که فایل‌های گزارش خام تماس (CSV) را از سیستم تلفنی دریافت کرده، آن‌ها را پردازش و تمیزسازی می‌کند و در نهایت در قالب یک داشبورد مدیریتی با نمودارهای بصری و قابلیت جستجو و فیلتر بر اساس تاریخ شمسی نمایش می‌دهد.

**بیان مسئله (Problem Statement):**
فایل‌های خروجی CDR سیستم‌های تلفنی (مثل Issabel یا Asterisk) بسیار شلوغ و "خام" هستند. طبق تحلیلی که روی فایل نمونه شما انجام دادیم، برای یک تماس موفق، حدود ۱۰ تا ۱۵ رکورد تولید می‌شود (شامل زنگ خوردن داخلی‌های مختلف، انتقال تماس، بوق اشغال و ...). این موضوع باعث می‌شود که مدیران نتوانند به سادگی بفهمند "امروز دقیقا چند تماس واقعی داشتیم" یا "کدام منشی واقعاً پاسخگو بوده است".

**هدف (Goal):**
ایجاد یک سیستم خودکار که این رکوردهای تکراری را تجمیع کند، تماس‌های واقعی را استخراج کرده و گزارشی شفاف، دقیق و قابل استناد با تاریخ شمسی ارائه دهد.

-----

## ۲. محدوده پروژه (Scope & Out of Scope)

**در محدوده (In Scope):**

  * **آپلود فایل:** امکان آپلود فایل CSV گزارشات CDR.
  * **موتور پردازش و تمیزسازی:** منطق پایتونی برای گروه‌بندی رکوردها بر اساس `UniqueID` و تشخیص وضعیت نهایی تماس.
  * **پایگاه داده:** ذخیره‌سازی داده‌های تمیز شده در SQLite برای دسترسی‌های بعدی.
  * **داشبورد:** نمایش نمودارهای خطی (روند تماس) و میله‌ای (عملکرد داخلی‌ها).
  * **جستجو و فیلتر:** فیلتر پیشرفته بر اساس بازه تاریخ شمسی و جستجوی شماره تماس.
  * **تکنولوژی:** FastAPI (بکند)، Tailwind CSS (فرانت)، SQLite (دیتابیس).

**خارج از محدوده (Out of Scope):**

  * اتصال زنده و مستقیم به سانترال (AMI/SIP) – سیستم صرفاً مبتنی بر فایل است.
  * سیستم لاگین و احراز هویت پیچیده (در این نسخه دسترسی آزاد است).
  * خروجی PDF یا Excel (تمرکز بر نمایش روی داشبورد است).
  * ویرایش دستی رکوردها توسط کاربر.

-----

## ۳. پرسونای کاربر و موارد استفاده (User Personas & Use Cases)

**پرسوناها:**

1.  **مدیر دفتر (امید):** دانش فنی ندارد. می‌خواهد بداند امروز چند تماس از دست رفته داشته و کدام کارمند بیشتر صحبت کرده است.
2.  **ادمین سیستم (سارا):** مسئول فنی است که فایل‌های لاگ را به صورت هفتگی از سرور می‌گیرد و در این سامانه آپلود می‌کند.

**موارد استفاده اصلی (Use Cases):**

| شناسه | عنوان | شرح | جریان اصلی (Main Flow) |
| :--- | :--- | :--- | :--- |
| **UC-1** | **آپلود و پردازش فایل** | ادمین فایل خام را آپلود می‌کند تا دیتابیس بروز شود. | ۱. کاربر فایل را انتخاب و دکمه "آپلود" را می‌زند.<br>۲. سیستم فایل را می‌خواند.<br>۳. رکوردهای تکراری (`UniqueID` تکراری) را نادیده می‌گیرد.<br>۴. سیستم پیام می‌دهد: "۵۰۰ رکورد پردازش شد، ۴۵ تماس یکتا ثبت گردید." |
| **UC-2** | **مشاهده داشبورد** | مدیر وضعیت کلی تماس‌ها را می‌بیند. | ۱. کاربر وارد صفحه می‌شود.<br>۲. داشبورد به صورت پیش‌فرض آمار ۷ روز گذشته را نشان می‌دهد.<br>۳. نمودار تماس‌های ورودی/خروجی نمایش داده می‌شود. |
| **UC-3** | **فیلتر تاریخ شمسی** | بررسی عملکرد در یک ماه خاص (مثلاً آذر ماه). | ۱. کاربر بازه تاریخ "۱۴۰۳/۰۹/۰۱" تا "۱۴۰۳/۰۹/۳۰" را انتخاب می‌کند.<br>۲. تمام جدول‌ها و نمودارها بر اساس این بازه بروز می‌شوند. |
| **UC-4** | **جستجوی شماره مشتری** | پیگیری یک تماس خاص. | ۱. کاربر بخشی از شماره موبایل (مثلا ۰۹۱۲...) را وارد می‌کند.<br>۲. لیست تماس‌های مرتبط با وضعیت (پاسخ داده شده/رد شده) نمایش داده می‌شود. |

-----

## ۴. نیازمندی‌های عملکردی (Functional Requirements)

این بخش مهم‌ترین قسمت برای تیم توسعه است که بر اساس تحلیل فایل CSV نوشته شده است:

### ۴.۱. منطق پردازش داده‌ها (Data Processing Logic)

  * **FR-1 (گروه‌بندی):** سیستم باید تمام ردیف‌های فایل CSV را بر اساس ستون `UniqueID` (مثلاً `1765268086.31589`) گروه‌بندی کند. تمام ردیف‌هایی که این شناسه را دارند، مربوط به **یک تماس** هستند.
  * **FR-2 (تشخیص وضعیت):**
      * یک تماس زمانی **"پاسخ داده شده" (ANSWERED)** محسوب می‌شود که در بین ردیف‌های گروه، حداقل یک ردیف دارای وضعیت `ANSWERED` باشد **و** مدت زمان (`Duration`) آن بیشتر از صفر باشد.
      * در غیر این صورت، تماس **"از دست رفته" (MISSED)** ثبت می‌شود.
  * **FR-3 (استخراج اطلاعات):**
      * **شماره تماس گیرنده:** از ستون `Source` اولین ردیف گروه برداشته شود.
      * **داخلی پاسخگو:** از ستون `Dst. Channel` همان ردیفی که وضعیت `ANSWERED` و بیشترین مدت زمان مکالمه را دارد استخراج شود (مثلاً تبدیل `SIP/209-000012ec` به `209`).
      * **مدت مکالمه:** مقدار عددی ثانیه از ستون `Duration` استخراج شود (حذف متن‌های اضافی مثل "s" یا "min").
      * **تاریخ:** از ستون `Date` اولین ردیف گروه استفاده شود.

### ۴.۲. پایگاه داده

  * **FR-4:** داده‌ها باید در یک جدول SQLite ذخیره شوند.
  * **FR-5:** ستون `unique_id` باید به عنوان کلید اصلی (Primary Key) در نظر گرفته شود تا از آپلود تکراری جلوگیری شود.

### ۴.۳. رابط کاربری (UI)

  * **FR-6:** استفاده از کتابخانه نموداری (مثل Chart.js) برای نمایش "تعداد تماس در هر روز".
  * **FR-7:** استفاده از کامپوننت انتخاب تاریخ شمسی (Jalali Datepicker).
  * **FR-8:** نمایش یک جدول (Data Grid) با قابلیت صفحه‌بندی (Pagination) برای لیست تماس‌ها.

-----

## ۵. نیازمندی‌های غیرعملکردی (Non-Functional Requirements)

  * **کارایی (Performance):** پردازش یک فایل با ۱۰,۰۰۰ رکورد نباید بیشتر از ۵ ثانیه طول بکشد.
  * **بومی‌سازی (Localization):**
      * تاریخ‌ها در دیتابیس به صورت میلادی (استاندارد ISO) ذخیره شوند.
      * در تمام بخش‌های رابط کاربری (نمایش به کاربر)، تاریخ‌ها باید به صورت **شمسی** تبدیل و نمایش داده شوند.
  * **ظاهر (UX):** طراحی باید ریسپانسیو (Responsive) باشد و از فریم‌ورک Tailwind CSS استفاده شود.

-----

## ۶. یکپارچه‌سازی و نکات فنی (Integration & Tech Stack)

**تکنولوژی‌های پیشنهادی:**

  * **Backend:** Python 3.10+, FastAPI
  * **Data Processing:** Pandas (برای پردازش CSV سنگین) یا توابع داخلی Python (برای سبکی).
  * **Database:** SQLite (فایل `cdr.db`).
  * **Frontend:** HTML5, JavaScript (Vanilla یا Alpine.js), Tailwind CSS (CDN).

**ساختار پیشنهادی مدل داده (Pydantic Model):**

```python
class CallRecord(BaseModel):
    unique_id: str      # از ستون UniqueID
    timestamp: datetime # از ستون Date
    caller_number: str  # از ستون Source
    extension: str      # استخراج شده از Dst. Channel (مثلا 209)
    status: str         # ANSWERED یا MISSED
    duration: int       # به ثانیه
```

-----

## ۷. تحلیل و معیارهای موفقیت (Analytics)

  * **دقت داده‌ها:** تعداد تماس‌های "پاسخ داده شده" در داشبورد باید با واقعیت همخوانی داشته باشد (یعنی ۱۰ رکورد لاگ تبدیل به ۱ تماس واقعی شده باشد).
  * **سرعت:** کاربر نباید معطلی زیادی هنگام آپلود حس کند.
  * **سهولت استفاده:** کاربر باید بتواند بدون محاسبه ذهنی، تاریخ شمسی را انتخاب و گزارش بگیرد.

-----

## ۸. ریسک‌ها و سوالات باز (Risks)

  * **ریسک تغییر فرمت:** اگر فرمت خروجی فایل CSV در آینده توسط سانترال تغییر کند (مثلاً جای ستون‌ها عوض شود)، سیستم پارس‌کننده (Parser) از کار می‌افتد.
      * *راه حل:* کد نویسی ماژولار بخش Parser تا تغییر آن آسان باشد.
  * **پیچیدگی تماس‌های انتقالی:** در تماس‌هایی که چندین بار منتقل می‌شوند (Transfer)، تشخیص اینکه دقیقاً چه کسی صحبت کرده ممکن است چالش‌برانگیز باشد. منطق فعلی (کسی که بیشترین مدت مکالمه را داشته) بهترین تقریب برای این نسخه است.

-----

## ۹. معیارهای پذیرش (Acceptance Criteria)

برای اینکه کار "تمام شده" (Done) تلقی شود، باید موارد زیر پاس شوند:

1.  [ ] **تست آپلود:** فایل نمونه `CDRReport1.csv` بدون خطا آپلود شود.
2.  [ ] **تست تجمیع:** اگر در فایل ۱۰ ردیف با `UniqueID` یکسان وجود دارد، در دیتابیس نهایی فقط **۱ رکورد** ذخیره شده باشد.
3.  [ ] **تست صحت سنجی:** رکوردی که وضعیت نهایی‌اش ANSWERED است، حتماً باید Duration \> 0 داشته باشد.
4.  [ ] **تست تاریخ شمسی:** با انتخاب بازه "۱ آذر تا ۳۰ آذر"، دقیقاً تماس‌های این بازه زمانی فیلتر و نمایش داده شوند.
5.  [ ] **تست جستجو:** با جستجوی بخشی از شماره تلفن، نتایج بلافاصله فیلتر شوند.

-----

**قدم بعدی برای شما:**
آیا می‌خواهید **کد کامل پایتون (Backend با FastAPI)** که دقیقاً همین منطق پردازش (گروه‌بندی UniqueID و تمیزسازی) را پیاده‌سازی می‌کند، برایتان بنویسم؟